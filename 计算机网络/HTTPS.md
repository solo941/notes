# HTTPS与HTTP

HTTP 有以下安全性问题：

- 使用明文进行通信，内容可能会被窃听；
- 不验证通信方的身份，通信方的身份有可能遭遇伪装；
- 无法证明报文的完整性，报文有可能遭篡改。

HTTPS 让 HTTP 先和 SSL（Secure Sockets Layer）通信，再由 SSL 和 TCP 通信，使用了隧道进行通信。通过使用 SSL，HTTPS 具有了加密（防窃听）、认证（防伪装）和完整性保护（防篡改）。

## 加密

### 对称密钥加密

加密和解密使用同一密钥。运算速度快但不能安全地将密钥传输给通信方。

![pic](https://github.com/solo941/notes/blob/master/计算机网络/pics/7fffa4b8-b36d-471f-ad0c-a88ee763bb76.png)

### 非对称密钥加密

加密和解密使用不同的密钥。公开密钥所有人都可以获得，通信发送方获得接收方的公开密钥之后，就可以使用公开密钥进行加密，接收方收到通信内容后使用私有密钥解密。

![pic](https://github.com/solo941/notes/blob/master/计算机网络/pics/39ccb299-ee99-4dd1-b8b4-2f9ec9495cb4.png)

###  HTTPS 采用的加密方式

HTTPS为了兼顾安全与效率，同时使用了对称加密和非对称加密。数据是被对称加密传输的，对称加密过程需要客户端的一个密钥，为了确保能把该密钥安全传输到服务器端，采用非对称加密对该密钥进行加密传输，总的来说，对数据进行对称加密，对称加密所要使用的密钥通过非对称加密传输。如图所示，服务器端的公钥和私钥，用来进行非对称加密；客户端生成的随机密钥，用来进行对称加密。

![pic](https://github.com/solo941/notes/blob/master/计算机网络/pics/How-HTTPS-Works.png)

整个过程如下：

一个HTTPS请求实际上包含了两次HTTP传输，可以细分为8步。
 1.客户端向服务器发起HTTPS请求，连接到服务器的443端口

2.服务器端有一个密钥对，即公钥和私钥，是用来进行非对称加密使用的，服务器端保存着私钥，不能将其泄露，公钥可以发送给任何人。

3.服务器将自己的公钥发送给客户端。

4.客户端收到服务器端的公钥之后，会对公钥进行检查，验证其合法性，如果发现发现公钥有问题，那么HTTPS传输就无法继续。严格的说，这里应该是验证服务器发送的数字证书的合法性，关于客户端如何验证数字证书的合法性，下文会进行说明。如果公钥合格，那么客户端会生成一个随机值，这个随机值就是用于进行对称加密的密钥，我们将该密钥称之为client key，即客户端密钥，这样在概念上和服务器端的密钥容易进行区分。然后用服务器的公钥对客户端密钥进行非对称加密，这样客户端密钥就变成密文了，至此，HTTPS中的第一次HTTP请求结束。

5.客户端会发起HTTPS中的第二个HTTP请求，将加密之后的客户端密钥发送给服务器。

6.服务器接收到客户端发来的密文之后，会用自己的私钥对其进行非对称解密，解密之后的明文就是客户端密钥，然后用客户端密钥对数据进行对称加密，这样数据就变成了密文。

7.然后服务器将加密后的密文发送给客户端。

8.客户端收到服务器发送来的密文，用客户端密钥对其进行对称解密，得到服务器发送的数据。这样HTTPS中的第二个HTTP请求结束，整个HTTPS传输完成。

## 认证

数字证书认证机构（CA，Certificate Authority）是客户端与服务器双方都可信赖的第三方机构。通过使用证书来对通信方进行认证。服务器的运营人员向 CA 提出公开密钥的申请，CA 在判明提出申请者的身份之后，会对已申请的公开密钥做数字签名，然后分配这个已签名的公开密钥，并将该公开密钥放入公开密钥证书后绑定在一起。进行 HTTPS 通信时，服务器会把证书发送给客户端。客户端取得其中的公开密钥之后，先使用数字签名进行验证，如果验证通过，就可以开始通信了。

![pic](https://github.com/solo941/notes/blob/master/计算机网络/pics/2017-06-11-ca.png)

## 完整性保护

SSL 提供报文摘要功能来进行完整性保护，它结合了加密和认证这两个操作。

## 面试题解析

**面试题1**.**从 URL 在浏览器被被输入到页面展现的过程中发生了什么？**

1、浏览器会先把url中域名解析成对应ip,
2、解析成ip之后建立与服务器的连接（三次握手）
3、与服务器建立连接之后，发送请求，
4、服务器接受请求之后，处理请求并完成响应
5、浏览器的接受数据和页面渲染,构建DOM树
6、关闭tcp连接（四次挥手）

### 域名解析

过程如下：

1、浏览器先检查本地host文件是否有当前网站的映射， 有则调用
2、如果没有，会查找本地DNS解析器缓存，有则走缓存
3、如果没有，会查找本地DNS服务器(提供本地连接的服务商)，有则调用
4、如果没有，会迭代查询（根域名服务器 -> 顶级域 -> 第二层域 -> 子域）

![pic](https://github.com/solo941/notes/blob/master/计算机网络/pics/4078ccd6h7afb21339ebb%26690.jpg)

**DNS负载均衡**：当一个网站有足够多的用户的时候，假如每次请求的资源都位于同一台机器上面，那么这台机器随时可能会蹦掉。处理办法就是用DNS负载均衡技术，它的原理是在DNS服务器中为同一个主机名配置多个IP地址,在应答DNS查询时,DNS服务器对每个查询将以DNS文件中主机记录的IP地址按顺序返回不同的解析结果,将客户端的访问引导到不同的机器上去,使得不同的客户端访问不同的服务器,从而达到负载均衡的目的｡

### 与服务器建立TCP连接

在通过第一步的DNS域名解析后，获取到了服务器的IP地址，在获取到IP地址后，便会开始建立一次连接，这是由TCP协议完成的，主要通过大家听了好多遍的三次握手进行连接。

“三次握手”的目的是“为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误”。

### 客户端发送请求

![pic](https://github.com/solo941/notes/blob/master/计算机网络/pics/微信截图_20190810171222.png)

请求报文由请求行（request line）、请求头（header）、请求体三个部分组成。

![pic](https://github.com/solo941/notes/blob/master/计算机网络/pics/httprequest.png)

### 服务器发送响应

响应报文由响应行（request line）、响应头部（header）、响应主体三个部分组成

相应行：如HTTP/1.1 200 OK

相应头部：响应头部包含响应报文的附加信息。

响应主体包含回车符、换行符和响应返回数据，并不是所有响应报文都有响应数据

![pic](https://github.com/solo941/notes/blob/master/计算机网络/pics/httpResponse.png)

### **浏览器的接受数据和页面渲染,构建DOM树**

- 根据 HTML 解析出 DOM 树
- 根据 CSS 解析生成 CSS 规则树
- 结合 DOM 树和 CSS 规则树，生成渲染树
- 根据渲染树计算每一个节点的信息
- 根据计算好的信息绘制页面

### **关闭tcp连接（四次挥手）**

客户端发送FIN连接请求释放连接后，服务器接受请求后进入CLOSE_WAIT状态，这个状态就是为了让服务段发送还没有发送完的数据，发送完成后再发送FIN信号。

**面试题2**：**收到的 HTML 如果包含几十个图片标签，这些图片是以什么方式、什么顺序、建立了多少连接、使用什么协议被下载下来的呢？**

如果图片都是 HTTPS 连接并且在同一个域名下，那么浏览器在 SSL 握手之后会和服务器商量能不能用 HTTP2，如果能的话就使用 Multiplexing 功能在这个连接上进行多路传输。不过也未必会所有挂在这个域名的资源都会使用一个 TCP 连接去获取，但是可以确定的是 Multiplexing 很可能会被用到。

如果发现用不了 HTTP2 呢？或者用不了 HTTPS（现实中的 HTTP2 都是在 HTTPS 上实现的，所以也就是只能使用 HTTP/1.1）。那浏览器就会在一个 HOST 上建立多个 TCP 连接，连接数量的最大限制取决于浏览器设置，这些连接会在空闲的时候被浏览器用来发送新的请求，如果所有的连接都正在发送请求呢？那其他的请求就只能等等了。

## 参考资料

[http](https://github.com/CyC2018/CS-Notes/blob/master/notes/HTTP.md#%E4%B9%9Dget-%E5%92%8C-post-%E6%AF%94%E8%BE%83)

[**Https原理及流程**](https://www.jianshu.com/p/14cd2c9d2cd2)

[**从输入URL到页面展示的详细过程**](https://blog.csdn.net/wlk2064819994/article/details/79756669)

[疯了吧！面试官 5 连问一个 TCP 连接可以发多少个 HTTP 请求？](https://mp.weixin.qq.com/s/bpbaDJQaO6dI375jzB2AoA)

